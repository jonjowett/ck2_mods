edmp_apply_invasion_permission_flag_to_this_character = {
	if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_01 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_01 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_02 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_02 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_03 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_03 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_04 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_04 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_05 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_05 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_06 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_06 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_07 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_07 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_08 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_08 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_09 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_09 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_10 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_10 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_11 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_11 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_12 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_12 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_13 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_13 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_14 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_14 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_15 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_15 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_16 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_16 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_17 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_17 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_18 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_18 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_19 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_19 duration = -1 hidden = yes inherit = yes }
		}
	}
	else_if = {
		limit = { NOT = { any_character = { has_character_modifier = edmp_invasion_permission_character_20 } } }
		custom_tooltip = {
			text = edmp_apply_invasion_permission_flag_to_this_character_tt
			add_character_modifier = {                    name = edmp_invasion_permission_character_20 duration = -1 hidden = yes inherit = yes }
		}
	}
	else = {
		custom_tooltip = { text = edmp_warning_no_invasion_permission_flags_remaining_tt }
	}
}

edmp_remove_invasion_permission_flag_from_this_character = {
	
	# Show the "all permissions revoked" effect BEFORE the (possibly-very-long) list of individual CBs lost
	custom_tooltip = { text = edmp_remove_invasion_permission_flag_from_this_character_tt }
	
	# Tell the decision-taker that a notification will be sent.
	# NB: Be sure to keep this limit in-sync with the one below!
	if = {
		limit = {
			edmp_this_is_a_multiplayer_game = yes
			ai = no
		}
		custom_tooltip = { text = edmp_invasion_permission_notification_sent_tt }
	}
	
	# List of individual CBs lost.
	# Must remove these BEFORE removing the character modifier, because we need the modifier to detect which titles need to have their permissions revoked.
	# Do NOT notify players about each individual permission withdrawn, to avoid spam. (We will send a blanket notification at the end of this event.)
	any_title = {
		limit = { edmp_this_title_has_invasion_permission_flag_matching_prev_character = yes }
		edmp_remove_prev_characters_invasion_permission_flag_from_this_title_without_notification = yes
	}
	
	# Actual "all permissions revoked" effect, hidden because it's got a custom tooltip above.
	hidden_tooltip = {
		remove_character_modifier = edmp_invasion_permission_character_01
		remove_character_modifier = edmp_invasion_permission_character_02
		remove_character_modifier = edmp_invasion_permission_character_03
		remove_character_modifier = edmp_invasion_permission_character_04
		remove_character_modifier = edmp_invasion_permission_character_05
		remove_character_modifier = edmp_invasion_permission_character_06
		remove_character_modifier = edmp_invasion_permission_character_07
		remove_character_modifier = edmp_invasion_permission_character_08
		remove_character_modifier = edmp_invasion_permission_character_09
		remove_character_modifier = edmp_invasion_permission_character_10
		remove_character_modifier = edmp_invasion_permission_character_11
		remove_character_modifier = edmp_invasion_permission_character_12
		remove_character_modifier = edmp_invasion_permission_character_13
		remove_character_modifier = edmp_invasion_permission_character_14
		remove_character_modifier = edmp_invasion_permission_character_15
		remove_character_modifier = edmp_invasion_permission_character_16
		remove_character_modifier = edmp_invasion_permission_character_17
		remove_character_modifier = edmp_invasion_permission_character_18
		remove_character_modifier = edmp_invasion_permission_character_19
		remove_character_modifier = edmp_invasion_permission_character_20
	}
	
	# If THIS is a player character in multiplayer, notify all players that the host has withdrawn invasion permissions.
	# NB: Be sure to keep this limit in-sync with the one above!
	hidden_tooltip = {
		if = {
			limit = {
				edmp_this_is_a_multiplayer_game = yes
				ai = no
			}
			save_event_target_as = edmp_ipn_character
			random_player = {
				preferred_limit = { is_multiplayer_host_character = yes }
				any_player = { character_event = { id = edmp_ipn.3000 } }
			}
			clear_event_target = edmp_ipn_character
		}
	}
	
}

edmp_apply_prev_characters_invasion_permission_flag_to_this_title = {
	custom_tooltip = {
		text = edmp_apply_prev_characters_invasion_permission_flag_to_this_title_tt
		if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_01 } }
			set_flag                                      = edmp_invasion_permission_title_01
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_02 } }
			set_flag                                      = edmp_invasion_permission_title_02
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_03 } }
			set_flag                                      = edmp_invasion_permission_title_03
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_04 } }
			set_flag                                      = edmp_invasion_permission_title_04
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_05 } }
			set_flag                                      = edmp_invasion_permission_title_05
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_06 } }
			set_flag                                      = edmp_invasion_permission_title_06
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_07 } }
			set_flag                                      = edmp_invasion_permission_title_07
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_08 } }
			set_flag                                      = edmp_invasion_permission_title_08
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_09 } }
			set_flag                                      = edmp_invasion_permission_title_09
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_10 } }
			set_flag                                      = edmp_invasion_permission_title_10
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_11 } }
			set_flag                                      = edmp_invasion_permission_title_11
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_12 } }
			set_flag                                      = edmp_invasion_permission_title_12
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_13 } }
			set_flag                                      = edmp_invasion_permission_title_13
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_14 } }
			set_flag                                      = edmp_invasion_permission_title_14
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_15 } }
			set_flag                                      = edmp_invasion_permission_title_15
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_16 } }
			set_flag                                      = edmp_invasion_permission_title_16
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_17 } }
			set_flag                                      = edmp_invasion_permission_title_17
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_18 } }
			set_flag                                      = edmp_invasion_permission_title_18
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_19 } }
			set_flag                                      = edmp_invasion_permission_title_19
		}
		else_if = {
			limit = { PREV = { has_character_modifier = edmp_invasion_permission_character_20 } }
			set_flag                                      = edmp_invasion_permission_title_20
		}
		else = {
			# Weird logic error, do nothing
		}
	}
	
	# If PREV is a player character in multiplayer, notify all players that the host has given invasion permission.
	if = {
		limit = {
			edmp_this_is_a_multiplayer_game = yes
			PREV = { ai = no }
		}
		custom_tooltip = {
			text = edmp_invasion_permission_notification_sent_tt
			save_event_target_as = edmp_ipn_title
			PREV = { save_event_target_as = edmp_ipn_character }
			random_player = {
				preferred_limit = { is_multiplayer_host_character = yes }
				any_player = { character_event = { id = edmp_ipn.2001 } }
			}
			clear_event_target = edmp_ipn_title
			clear_event_target = edmp_ipn_character
		}
	}
	
}

edmp_remove_prev_characters_invasion_permission_flag_from_this_title = {
	
	edmp_remove_prev_characters_invasion_permission_flag_from_this_title_without_notification = yes
	
	# If PREV is a player character in multiplayer, notify all players that the host has withdrawn invasion permissions.
	if = {
		limit = {
			edmp_this_is_a_multiplayer_game = yes
			PREV = { ai = no }
		}
		custom_tooltip = {
			text = edmp_invasion_permission_notification_sent_tt
			save_event_target_as = edmp_ipn_title
			PREV = { save_event_target_as = edmp_ipn_character }
			random_player = {
				preferred_limit = { is_multiplayer_host_character = yes }
				any_player = { character_event = { id = edmp_ipn.3001 } }
			}
			clear_event_target = edmp_ipn_title
			clear_event_target = edmp_ipn_character
		}
	}
	
}

edmp_remove_prev_characters_invasion_permission_flag_from_this_title_without_notification = {
	custom_tooltip = {
		text = edmp_remove_prev_characters_invasion_permission_flag_from_this_title_tt
		if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_01 }
				has_flag                            = edmp_invasion_permission_title_01
			}
			clr_flag                                    = edmp_invasion_permission_title_01
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_02 }
				has_flag                            = edmp_invasion_permission_title_02
			}
			clr_flag                                    = edmp_invasion_permission_title_02
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_03 }
				has_flag                            = edmp_invasion_permission_title_03
			}
			clr_flag                                    = edmp_invasion_permission_title_03
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_04 }
				has_flag                            = edmp_invasion_permission_title_04
			}
			clr_flag                                    = edmp_invasion_permission_title_04
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_05 }
				has_flag                            = edmp_invasion_permission_title_05
			}
			clr_flag                                    = edmp_invasion_permission_title_05
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_06 }
				has_flag                            = edmp_invasion_permission_title_06
			}
			clr_flag                                    = edmp_invasion_permission_title_06
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_07 }
				has_flag                            = edmp_invasion_permission_title_07
			}
			clr_flag                                    = edmp_invasion_permission_title_07
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_08 }
				has_flag                            = edmp_invasion_permission_title_08
			}
			clr_flag                                    = edmp_invasion_permission_title_08
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_09 }
				has_flag                            = edmp_invasion_permission_title_09
			}
			clr_flag                                    = edmp_invasion_permission_title_09
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_10 }
				has_flag                            = edmp_invasion_permission_title_10
			}
			clr_flag                                    = edmp_invasion_permission_title_10
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_11 }
				has_flag                            = edmp_invasion_permission_title_11
			}
			clr_flag                                    = edmp_invasion_permission_title_11
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_12 }
				has_flag                            = edmp_invasion_permission_title_12
			}
			clr_flag                                    = edmp_invasion_permission_title_12
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_13 }
				has_flag                            = edmp_invasion_permission_title_13
			}
			clr_flag                                    = edmp_invasion_permission_title_13
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_14 }
				has_flag                            = edmp_invasion_permission_title_14
			}
			clr_flag                                    = edmp_invasion_permission_title_14
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_15 }
				has_flag                            = edmp_invasion_permission_title_15
			}
			clr_flag                                    = edmp_invasion_permission_title_15
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_16 }
				has_flag                            = edmp_invasion_permission_title_16
			}
			clr_flag                                    = edmp_invasion_permission_title_16
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_17 }
				has_flag                            = edmp_invasion_permission_title_17
			}
			clr_flag                                    = edmp_invasion_permission_title_17
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_18 }
				has_flag                            = edmp_invasion_permission_title_18
			}
			clr_flag                                    = edmp_invasion_permission_title_18
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_19 }
				has_flag                            = edmp_invasion_permission_title_19
			}
			clr_flag                                    = edmp_invasion_permission_title_19
		}
		else_if = {
			limit = {
				PREV = { has_character_modifier = edmp_invasion_permission_character_20 }
				has_flag                            = edmp_invasion_permission_title_20
			}
			clr_flag                                    = edmp_invasion_permission_title_20
		}
		else = {
			# Weird logic error, do nothing
		}
	}
}